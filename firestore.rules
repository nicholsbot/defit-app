rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Validate workout log fields
    function isValidWorkoutLog() {
      let data = request.resource.data;
      return data.week is int
          && data.week >= 1
          && data.week <= 10
          && data.tmarMMinutes is number
          && data.resistanceLbs is number
          && data.cardioMilesRunning is number
          && data.cardioMilesRucking is number
          && data.cardioMilesWalking is number
          && data.cardioMilesElliptical is number
          && data.cardioMilesRowing is number
          && data.cardioMetersSwimming is number
          && data.cardioMilesCycling is number
          && data.hiitMinutes is number
          && data.userProfileId is string
          && data.workoutDate is string;
    }
    
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create, update: if isOwner(userId);
      allow delete: if false;
    }

    match /workoutLogs/{logId} {
      allow read: if isSignedIn();
      allow create: if isOwner(request.resource.data.userProfileId)
                    && isValidWorkoutLog()
                    && request.resource.data.userProfileId == request.auth.uid;
      allow update: if isOwner(resource.data.userProfileId)
                    && isValidWorkoutLog();
      allow delete: if isOwner(resource.data.userProfileId);
    }
  }
}
